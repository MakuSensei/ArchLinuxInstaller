
function setup_lighttpd() {
	systemctl enable lighttpd

	mkdir -p /etc/lighttpd/conf.d/

	echo 'server.modules += ("mod_fastcgi")' >> /etc/lighttpd/conf.d/fastcgi.conf
	echo 'index-file.names += ("index.php")' >> /etc/lighttpd/conf.d/fastcgi.conf
	echo '' > /etc/lighttpd/conf.d/fastcgi.conf
	echo 'fastcgi.server = (' >> /etc/lighttpd/conf.d/fastcgi.conf
	echo '    ".php" => ("localhost" => ("bin-path" => "/usr/bin/php-cgi", "socket" => "/tmp/php-fastcgi.sock", "broken-scriptfilename" => "enable", "max-procs" => 4, "bin-environment" => ("PHP_FCGI_CHILDREN" => "1")))' >> /etc/lighttpd/conf.d/fastcgi.conf
	echo ')' >> /etc/lighttpd/conf.d/fastcgi.conf

	echo '' >>  /etc/lighttpd/lighttpd.conf
	echo 'include "conf.d/fastcgi.conf"' >>  /etc/lighttpd/lighttpd.conf

	echo '<?php phpinfo(); ?>' > /srv/http/index.php
	chmod 755 /srv/http/index.php
}

function setup_mysql() {
	chown mysql:mysql -R /var/lib/mysql
	chown mysql:mysql -R /var/run/mysqld
	
	systemctl enable mysqld
	#systemctl start mysqld
	
	#mysql --user=root -e "UPDATE mysql.user SET Password=PASSWORD('pass') WHERE User='root';\nDELETE FROM mysql.user WHERE User='';\nDELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');\nDROP DATABASE test;\nDELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';\nFLUSH PRIVILEGES;\nGRANT ALL PRIVILEGES ON *.* TO 'root'@'192.168.1.%' IDENTIFIED BY 'pass' WITH GRANT OPTION;"
	#mysql_upgrade -u root -ppass
	#mysql_tzinfo_to_sql /usr/share/zoneinfo | mysql -u root -ppass mysql

	sed -i 's/;\(extension=mysql.so\)/\1/g' /etc/php/php.ini
}


function setup_packages() {
	packages=""
    
	packages+=" lighttpd fcgi php php-cgi"
	packages+=" mariadb"
	
	pacman -S --needed --noconfirm $packages
}


function install_all() {
	setup_packages
	setup_mysql
	setup_lighttpd
}

trap 'echo "Error on line $LINENO"' ERR
set -e

if [ $SUDO_USER ]; then
	HOME=/home/$SUDO_USER
	USER=$SUDO_USER
fi

if [ $1 ]; then
	eval $1
	echo "'$1' run successfully!"
else
	install_all
	echo "install completed successfully!"
fi